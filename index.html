<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>CRUD SQLite – trwała baza</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/sql-wasm.js"></script>

  <style>
    body { font-family: Arial; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 15px; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    th { background: #eee; }
    input { padding: 5px; margin: 5px; }
    button { padding: 5px 10px; margin: 5px; }
  </style>
</head>
<body>

  <h2>CRUD – SQLite z zapisywaniem danych</h2>

  <h3>Dodaj użytkownika</h3>
  <input id="add_id" placeholder="ID">
  <input id="add_name" placeholder="Imię">
  <button onclick="createUser()">Dodaj</button>

  <h3>Lista użytkowników</h3>
  <div id="table"></div>

  <script>
    let db;
    let SQL;

    // ======= IndexedDB =======
    const DB_NAME = "moja_baza_sqlite";
    const STORE_NAME = "sqlite_store";

    function saveToIndexedDB(data) {
      return new Promise((resolve) => {
        const req = indexedDB.open(DB_NAME, 1);
        req.onupgradeneeded = () => req.result.createObjectStore(STORE_NAME);
        req.onsuccess = () => {
          const tx = req.result.transaction(STORE_NAME, "readwrite");
          tx.objectStore(STORE_NAME).put(data, "dbfile");
          tx.oncomplete = resolve;
        };
      });
    }

    function loadFromIndexedDB() {
      return new Promise((resolve) => {
        const req = indexedDB.open(DB_NAME, 1);
        req.onupgradeneeded = () => req.result.createObjectStore(STORE_NAME);
        req.onsuccess = () => {
          const tx = req.result.transaction(STORE_NAME, "readonly");
          const getReq = tx.objectStore(STORE_NAME).get("dbfile");
          getReq.onsuccess = () => resolve(getReq.result || null);
        };
      });
    }

    // ======= START aplikacji =======
    initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/${file}` })
      .then(async (SQLLib) => {
        SQL = SQLLib;

        const saved = await loadFromIndexedDB();

        if (saved) {
          // wczytujemy bazę z IndexedDB
          db = new SQL.Database(new Uint8Array(saved));
        } else {
          // tworzymy nową bazę
          db = new SQL.Database();
          db.run(`
            CREATE TABLE users (id INTEGER PRIMARY KEY, name TEXT);
            INSERT INTO users VALUES (1, 'Ada');
            INSERT INTO users VALUES (2, 'Bartek');
            INSERT INTO users VALUES (3, 'Celina');
          `);
        }

        refreshTable();
      });

    function saveDB() {
      const data = db.export();
      saveToIndexedDB(data);
    }

    function refreshTable() {
      const res = db.exec("SELECT * FROM users");
      if (res.length === 0) return;

      const rows = res[0].values;
      let html = "<table><tr><th>ID</th><th>Imię</th><th>Akcje</th></tr>";

      rows.forEach(row => {
        html += `
          <tr>
            <td>${row[0]}</td>
            <td><input id="name_${row[0]}" value="${row[1]}"></td>
            <td>
              <button onclick="updateUser(${row[0]})">Edytuj</button>
              <button onclick="deleteUser(${row[0]})">Usuń</button>
            </td>
          </tr>`;
      });

      html += "</table>";
      document.getElementById("table").innerHTML = html;
    }

    // CREATE
    function createUser() {
      const id = document.getElementById("add_id").value;
      const name = document.getElementById("add_name").value;
      db.run("INSERT INTO users VALUES (?, ?)", [id, name]);
      saveDB();
      refreshTable();
    }

    // UPDATE
    function updateUser(id) {
      const newName = document.getElementById("name_" + id).value;
      db.run("UPDATE users SET name = ? WHERE id = ?", [newName, id]);
      saveDB();
      refreshTable();
    }

    // DELETE
    function deleteUser(id) {
      db.run("DELETE FROM users WHERE id = ?", [id]);
      saveDB();
      refreshTable();
    }
  </script>

</body>
</html>
