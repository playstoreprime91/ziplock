<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <title>CRUD — Supabase (wspólna baza)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 900px; margin: auto; }
    table { border-collapse: collapse; width: 100%; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background:#f2f2f2; }
    input, button { padding: 6px; margin: 4px 6px 4px 0; }
    #status { margin-top: 8px; color: #666; font-size: 14px; }
  </style>
  <!-- supabase-js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
</head>
<body>
  <h2>CRUD — Supabase (wspólna baza)</h2>

  <h3>Dodaj użytkownika</h3>
  <input id="add_id" placeholder="ID (liczba)" type="number">
  <input id="add_name" placeholder="Imię" type="text">
  <button id="btnAdd">Dodaj</button>

  <h3>Lista użytkowników</h3>
  <div id="table"></div>

  <div id="status"></div>

<script>
  // -> Wklej tutaj swoje wartości:
  const SUPABASE_URL = "https://xxxxxx.supabase.co"; // <- zamień
  const SUPABASE_ANON_KEY = "eyJ..."; // <- zamień

  const supabase = supabaseLib.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const statusEl = document.getElementById('status');

  // Fetch i render
  async function fetchUsers() {
    setStatus('Ładowanie użytkowników...');
    const { data, error } = await supabase
      .from('users')
      .select('*')
      .order('id', { ascending: true });

    if (error) {
      setStatus('Błąd ładowania: ' + error.message);
      console.error(error);
      return;
    }

    renderTable(data || []);
    setStatus('Gotowe. Ostatnia aktualizacja: ' + new Date().toLocaleTimeString());
  }

  function renderTable(rows) {
    let html = `<table><tr><th>ID</th><th>Imię</th><th>Akcje</th></tr>`;
    rows.forEach(r => {
      html += `
        <tr>
          <td>${r.id}</td>
          <td><input id="name_${r.id}" value="${escapeHtml(r.name || '')}"></td>
          <td>
            <button onclick="updateUser(${r.id})">Zapisz</button>
            <button onclick="deleteUser(${r.id})">Usuń</button>
          </td>
        </tr>
      `;
    });
    html += `</table>`;
    document.getElementById('table').innerHTML = html;
  }

  // CREATE
  async function createUser() {
    const id = parseInt(document.getElementById('add_id').value, 10);
    const name = document.getElementById('add_name').value.trim();

    if (!Number.isInteger(id) || name === '') {
      alert('Podaj poprawne ID i imię.');
      return;
    }

    setStatus('Dodawanie...');
    const { error } = await supabase
      .from('users')
      .insert([{ id, name }]);

    if (error) {
      setStatus('Błąd dodawania: ' + error.message);
      console.error(error);
    } else {
      setStatus('Użytkownik dodany.');
      document.getElementById('add_id').value = '';
      document.getElementById('add_name').value = '';
      // fetchUsers();  // nie musimy wywoływać jeśli działa realtime; inaczej odkomentuj
    }
  }

  // UPDATE
  async function updateUser(id) {
    const newName = document.getElementById('name_' + id).value.trim();
    if (newName === '') { alert('Imię nie może być puste'); return; }
    setStatus('Aktualizacja...');
    const { error } = await supabase
      .from('users')
      .update({ name: newName })
      .eq('id', id);

    if (error) {
      setStatus('Błąd aktualizacji: ' + error.message);
      console.error(error);
    } else {
      setStatus('Zapisano.');
    }
  }

  // DELETE
  async function deleteUser(id) {
    if (!confirm('Na pewno usunąć użytkownika o ID ' + id + '?')) return;
    setStatus('Usuwanie...');
    const { error } = await supabase
      .from('users')
      .delete()
      .eq('id', id);

    if (error) {
      setStatus('Błąd usuwania: ' + error.message);
      console.error(error);
    } else {
      setStatus('Usunięto.');
    }
  }

  // utilities
  function setStatus(txt) { statusEl.textContent = txt; }
  function escapeHtml(s) { return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  // Podłącz przyciski
  document.getElementById('btnAdd').addEventListener('click', createUser);

  // === Realtime (opcjonalnie) ===
  // Dzięki temu wszyscy widzą zmiany "na żywo".
  // Jeśli wolisz nie używać realtime, usuń poniższy blok i odkomentuj fetchUsers() w createUser()
  (function setupRealtime() {
    try {
      // subskrybuj wszystkie zmiany w tabeli users
      supabase.channel('public:users')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'users' }, payload => {
          console.log('Realtime payload', payload);
          // po każdej zmianie pobieramy aktualną listę
          fetchUsers();
        })
        .subscribe()
        .then(() => console.log('Realtime subscribed'));
    } catch (err) {
      console.warn('Realtime może nie być dostępne w tej wersji klienta lub konfiguracji', err);
    }
  })();

  // pierwsze załadowanie
  fetchUsers();
</script>
</body>
</html>
